- name: payment configurations
  hosts: payment
  become: yes

  tasks:
    - name: Install python3
      community.general.easy_install:
        name: "{{ item }}"
        state: present
      loop:
        - python
        - gcc
        - python-devel

    - name: creating the system payment roboshop
      ansible.builtin.user:
        name: roboshop
        system: true #system user
        home: /app #optionally setting home
        shell: /sbin/nologin
        comment: roboshop system user

    - name: delete app directory # Why are we deleting the directory? If we are running the playbook again, that means there might be code changes, right? If the code already exists, Ansible will skip the task when we run the playbook. So is that why we are deleting it?
      ansible.builtin.file:
        path: /app
        state: absent

    - name: create app directory
      ansible.builtin.file:
        path: /app
        state: directory

    - name: Delete the payment zip file #Why are we deleting the zip file? If we are running the playbook again, that means there might be code changes, right? If the code already exists, Ansible will skip the task when we run the playbook. So is that why we are deleting it?
      ansible.builtin.file:
        path: /tmp/payment.zip
        state: absent

    - name: Downloading the payment zip file
      ansible.builtin.get_url:
        url: https://roboshop-artifacts.s3.amazonaws.com/payment-v3.zip
        dest: /tmp/payment.zip

    - name: Unzip the code
      ansible.builtin.unarchive:
        src: /tmp/payment.zip
        dest: /app
        remote_src: yes #What does remote_src mean here? The payment code is not on the Ansible control node â€” it is already downloaded on the target server using the get_url command. So why do we need to mention remote_src: yes? If we remove it, we get an error.

    - name: Install the dependencies
      ansible.builtin.pip:
        requirements: requirements.txt # Directory containing requirements.txt
        executable: pip3.9

    - name: copy the payment service
      ansible.builtin.template: #We use the template module because it understands variables. It searches for the variable placeholders and replaces them with actual values. Otherwise, Ansible will treat them as plain text, and we may get errors.
        src: payment.service
        dest: /etc/systemd/system/payment.service

    - name: Start, enable & daemon-reload payment service
      ansible.builtin.systemd:
        name: payment
        daemon_reload: yes
        state: restarted #why we are restaring if its running it will restart
        enabled: yes
